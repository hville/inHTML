<!DOCTYPE html>
<head></head>

<script type=module>
//TODO tests with events, async defer await module document XPath
import {frame} from './browser.js'

//Timing
/* Notes:
		- document.readyState is missed with type=module async
		- readyState is loading with scripts (no DOM) and interractive with module
		- async and defer are unreliable
 */
const ts = `
let ts='\\njs:'+document.readyState;
onload=()=>(ts+='\\nonload:'+document.readyState);
document.addEventListener("DOMContentLoaded", ()=>(ts+='\\nonDOM:'+document.readyState))`
frame('()=>ts',ts,'').then(f => console.log('script',f()))
frame('()=>ts',ts,'async').then(f => console.log('async',f()))
frame('()=>ts',ts,'defer').then(f => console.log('defer',f()))
frame('()=>ts',ts,'async defer').then(f => console.log('async defer',f()))
frame('()=>ts',ts,'type=module').then(f => console.log('type=module',f()))
frame('()=>ts',ts,'type=module async').then(f => console.log('type=module async',f()))

//Context
async function test(msg,f) {
	//f.catch(e => console.log('!',e))
	document.body.append(await f(msg))
}

test('plain', await frame(`x=>x+'OK '`))
test('closure', await frame(`x=>x+y`, `const y='OK '`))
test('global', await frame(`x=>x+y`, `window.y='OK '`))
test('this_', await frame(`function(x) { return x+this.y }`, `window.y='OK '`))
test('dom', await frame(`x => x+document.body.textContent`, `onload = () => document.body.textContent='OK '`))
test('frameInFrame', await frame(
`async x => (await ff)(x)`,
`import {frame} from './in-frame.js';
const ff = frame('x=>x+"OK "')`))
</script>
</html>
